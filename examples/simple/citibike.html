<!--
   
   Copyright (c) 2017, the Perspective Authors.
   
   This file is part of the Perspective library, distributed under the terms of
   the Apache License 2.0.  The full license can be found in the LICENSE file.

-->

<!DOCTYPE html>
<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <script src="perspective.js"></script>
    <script src="perspective.view.js"></script>
    <script src="hypergrid.plugin.js"></script>
    <script src="highcharts.plugin.js"></script>

    <script src="perspective.js"></script>

    <link rel='stylesheet' href="index.css">
    <link rel='stylesheet' href="material.dark.css">
    

</head>

<body>

    <perspective-viewer>

    </perspective-viewer>

    <script>

        function get(url) {
            return new Promise(resolve => {
                const xhr = new XMLHttpRequest();
                xhr.open("GET", url, true);
                xhr.responseType = "json";
                xhr.onload = () => resolve(xhr.response);
                xhr.send(null);
            });
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function get_feed(feedname, callback) {
            const url = `https://gbfs.citibikenyc.com/gbfs/en/${feedname}.json`;
            const {data: {stations}, ttl} = await get(url);
            if (typeof callback === "function") {
                callback(stations);
                await sleep(ttl * 1000);
                get_feed(feedname, callback);
            } else {
                return stations;
            }
        }

        const worker = perspective.worker();

        async function get_schema(feed) {
            const table = worker.table(feed);
            const schema = await table.schema();
            table.delete();
            return schema;
        }

        async function merge_schemas(feeds) {
            const schemas = await Promise.all(feeds.map(get_schema));
            return Object.assign({}, ...schemas);
        }

        async function main() {
            const feednames = ["station_status", "station_information"];
            const feeds = await Promise.all(feednames.map(get_feed));
            const schema = await merge_schemas(feeds);

            const table = worker.table(schema, {index: "station_id"});
            for (let feed of feeds) {
                table.update(feed);
            }

            get_feed("station_status", table.update);

            const viewers = document.getElementsByTagName("perspective-viewer");
            for (viewer of viewers) {
                viewer.load(table);
            }

            viewers[0]._toggle_config();
        }

        main();

    </script>

</body>

</html>