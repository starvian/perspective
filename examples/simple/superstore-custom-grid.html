<!--
   
   Copyright (c) 2017, the Perspective Authors.
   
   This file is part of the Perspective library, distributed under the terms of
   the Apache License 2.0.  The full license can be found in the LICENSE file.

-->

<!DOCTYPE html>
<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

    <script src="perspective-viewer.js"></script>
    <script src="perspective-viewer-datagrid.js"></script>

    <link rel='stylesheet' href="index.css">
    <link rel='stylesheet' href="material-dense.css" is="custom-style">

</head>

<body>

    <perspective-viewer plugin="datagrid" columns='["Profit", "Sub-Category",
    "State", "Sales", "Category", "Order Date", "Quantity"]'>

    </perspective-viewer>

    <script>

        function hue(value, min, max) {
            const norm = "0" + Math.abs(Math.round(255 * Math.min(Math.max(value, min), max))).toString(16);
            return norm.slice(norm.length - 2, norm.length);
        }

        window.addEventListener('WebComponentsReady', async function() {
            const viewer = document.getElementsByTagName('perspective-viewer')[0];
            const data = await fetch("superstore.arrow");
            const arr = await data.arrayBuffer();
            viewer.load(arr.slice());
            viewer.toggleConfig();

            const CACHE = {}

            viewer.addEventListener("perspective-datagrid-after-update", () => {

                const cache = Object.keys(CACHE).reduce((obj, key) => {
                    obj[key] = CACHE[key].slice();
                    return obj;
                }, {});
    
                for (const td of document.querySelectorAll("perspective-viewer td")) {
                    const clean_name = td.value && td.value.trim && td.value.trim();
                    if (td.classList.contains("float")) {
                        if (td.value < 0) {
                            td.style.color = "#fff";
                            td.style.backgroundColor = `#${hue(td.value, -100, 0)}0000`;
                        } else if (td.value > 0) {
                            td.style.color = "#fff";
                            td.style.backgroundColor = `#00${hue(td.value, 0, 100)}00`;
                        } else {
                            td.style.color = "#000";
                            td.style.backgroundColor = "";
                        }
                    } else if (td.classList.contains("integer")) {
                        td.style.backgroundColor = "";
                        if (!td.value) {
                        } else {
                            td.innerHTML = `<div style="height:15px;width:${td.value || 0}px;background:linear-gradient(90deg, #2bb0af 0, #23a7d7);"><div>`;
                        }
                    } else if (states[clean_name]) {
                        td.style.backgroundColor = "";
                        if (cache[clean_name] && cache[clean_name].length > 0) {
                            const name = td.value;
                            td.innerHTML = "";
                            td.appendChild(cache[name].pop());
                        } else {
                            const name = td.value;
                            img = document.createElement("img");
                            img.setAttribute("src", `https://perspective.finos.org/img/flags/${states[clean_name].toLowerCase()}.png`);
                            img.setAttribute("height", "15");
                            td.appendChild(img);
                            CACHE[name] = CACHE[name] || [];
                            CACHE[name].push(img);                           
                        }
                        
                    } else {
                        td.style.backgroundColor = "";
                        td.style.color = "";                
                    }
                }
            });            

            const states = {
                "Alabama": "AL",
                "Alaska": "AK",
                "Arizona": "AZ",
                "Arkansas": "AR",
                "California": "CA",
                "Colorado": "CO",
                "Connecticut": "CT",
                "Delaware": "DE",
                "Florida": "FL",
                "Georgia": "GA",
                "Hawaii": "HI",
                "Idaho": "ID",
                "Illinois": "IL",
                "Indiana": "IN",
                "Iowa": "IA",
                "Kansas": "KS",
                "Kentucky": "KY",
                "Louisiana": "LA",
                "Maine": "ME",
                "Maryland": "MD",
                "Massachusetts": "MA",
                "Michigan": "MI",
                "Minnesota": "MN",
                "Mississippi": "MS",
                "Missouri": "MO",
                "Montana": "MT",
                "Nebraska": "NE",
                "Nevada": "NV",
                "New Hampshire": "NH",
                "New Jersey": "NJ",
                "New Mexico": "NM",
                "New York": "NY",
                "North Carolina": "NC",
                "North Dakota": "ND",
                "Ohio": "OH",
                "Oklahoma": "OK",
                "Oregon": "OR",
                "Pennsylvania": "PA",
                "Rhode Island": "RI",
                "South Carolina": "SC",
                "South Dakota": "SD",
                "Tennessee": "TN",
                "Texas": "TX",
                "Utah": "UT",
                "Vermont": "VT",
                "Virginia": "VA",
                "Washington": "WA",
                "West Virginia": "WV",
                "Wisconsin": "WI",
                "Wyoming": "WY"
            };
        
        });
    </script>

</body>

</html>



